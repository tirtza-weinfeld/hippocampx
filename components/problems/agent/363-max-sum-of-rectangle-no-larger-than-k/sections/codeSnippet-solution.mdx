```python meta="source=problems/363-max-sum-of-rectangle-no-larger-than-k/solution.py"
from bisect import bisect_left, insort

def max_sum_of_rectangle_no_larger_than_k(mat: list[list[int]], k: int) -> int:
    m, n = len(mat), len(mat[0])
    if m > n:
        mat = [list(r) for r in zip(*mat)]
        m, n = n, m

    def kadane_leq(arr: list[int], K: int) -> int | None:
        best = cur = arr[0]
        for x in arr[1:]:
            cur = x if cur < 0 else cur + x
            best = max(best, cur)
            if best == K:
                return K
        return best if best <= K else None

    ans = float("-inf")

    for l in range(n):
        row = [0] * m
        for r in range(l, n):
            for i in range(m):
                row[i] += mat[i][r]

            fast = kadane_leq(row, k)
            if fast is not None:
                ans = max(ans, fast)
                if ans == k:
                    return k
                continue

            s, pref = 0, [0]
            for v in row:
                s += v
                j = bisect_left(pref, s - k)
                if j < len(pref):
                    ans = max(ans, s - pref[j])
                    if ans == k:
                        return k
                insort(pref, s)

    return ans
```